/*
 * Duck Creek TaskBar JavaScript
 */
Ext.define("DCT.Mvc.PolicyLongProcessTaskbarGroup",{extend:"DCT.Mvc.TaskbarGroup",id:"LRPTaskbarGroup",xtype:"dctmvcpolicylongprocesstaskbargroup",text:DCT.T("Queue"),icon:"assets/taskbargroups/dctpolicy/img/blankIcon.png",iconCls:"clockIcon",menu:{xtype:"dctmvcpolicylongprocesstaskbargroupmenu"},controllerUrl:"longprocess/",emptyItemsData:{message:DCT.T("No processes...")},constructor:function(a){var b=this;b.callParent([a]);b.updateTaskBarGroup(a)},updateTaskBarGroup:function(a){var b;if(a.items.length>0){for(i=0;i<a.items.length;++i){if(a.items[i].notify=="failed"){b="clockIconError";break}if(a.items[i].notify=="success"){b="clockIconSuccess"}}Ext.getCmp("LRPTaskbarGroup").setText(DCT.T("Queue")+" ("+a.items.length+")")}else{Ext.getCmp("LRPTaskbarGroup").setText(DCT.T("Queue"));b="clockIcon"}Ext.getCmp("LRPTaskbarGroup").setIconCls(b)},deleteNote:function(b,c){var a=this.findParentByType("dctmvcpolicylongprocesstaskbargroup");a.confirmAction(DCT.T("AreYouSure"),DCT.T("AreYouSureDeleteNote"),a.doDeleteNote,a)}});Ext.define("DCT.Mvc.PolicyLongProcessTaskbarGroupMenu",{extend:"DCT.Mvc.TaskbarGroupMenu",xtype:"dctmvcpolicylongprocesstaskbargroupmenu",defaultFlyout:"flyoutProcessDetails",setFlyoutConfigs:function(){return[{xtype:"dctmvcpolicylongprocesstaskbargroupmenudetailsflyout"},{xtype:"dctmvcpolicylongprocesstaskbargroupmenuuserpreferencesflyout"}]},setMenuPanelXtype:function(){return"dctmvcpolicylongprocesstaskbargroupmenupanel"}});Ext.define("DCT.Mvc.PolicyLongProcessTaskbarGroupMenuDetailsFlyout",{extend:"DCT.Mvc.TaskbarGroupMenuFlyout",xtype:"dctmvcpolicylongprocesstaskbargroupmenudetailsflyout",bbar:[{xtype:"tbfill"}],cls:"dct-PolicyLongProcess-flyout",layout:"border",reference:"flyoutProcessDetails",title:DCT.T("Process Details"),tools:[{type:"close",itemId:"Close",qtip:DCT.T("Close"),handler:function(a,b,c){a.taskbarGroup.menu.hideFlyout()}}],width:300,tplCommentText:new Ext.XTemplate('<div class="tskbr-g-m-i-wrapper"><div class="tskbr-g-m-i-primary"><tpl if="commentTypeCode == &quot;CI&quot;"><img align="right" src="assets/taskbargroups/dctpolicy/img/page_key.png" alt="{[DCT.T("CommentIsInternal")]}" title="{[DCT.T("CommentIsInternal")]}"></tpl>{commentText}</div></div>').compile(),tplDetails:new Ext.XTemplate('<div class="tskbr-g-m-i-wrapper"><div class="tskbr-g-m-i-primary">{[DCT.T("TransactionStatus")]}: {policyStatus} - {type} - {transactionStatus}</div><div class="tskbr-g-m-i-secondaryleft">{[this.formatDate(values.creationDateTime)]}</div><div class="tskbr-g-m-i-secondaryright">{originator}</div><div class="x-clear"></div></div>',{formatDate:function(d){var c=Ext.getDom("_hiddenExtJsDateformat").value;var b=new Date.parseDate(d,"Y-m-d H:i");var a=b.format(c+", g:i a");return a}}).compile(),constructor:function(a){this.callParent([a]);this.buildPanel(a);this.addDeleteNoteButton()},update:function(){var a=this.taskbarGroup.activeMenuItem.initialConfig.data;this.regionSouth.update(a);this.regionCenter.update(a)},addDeleteNoteButton:function(){var a=this.setDeleteNoteButtonConfig();if(a!=false){this.getBottomToolbar().addButton(a)}},buildPanel:function(a){this.add({autoScroll:true,region:"south",reference:"regionSouth",tpl:this.tplDetails});this.add({autoScroll:true,region:"center",reference:"regionCenter",tpl:this.tplCommentText})},setDeleteNoteButtonConfig:function(){if(this.taskbarGroup.userHasPrivilege("CanDeleteNote")){return{xtype:"button",reference:"btnDeleteNote",handler:this.taskbarGroup.deleteNote,icon:"assets/taskbargroups/dctpolicy/img/note_delete.png",text:DCT.T("Delete")}}else{return false}}});Ext.define("DCT.Mvc.PolicyLongProcessTaskbarGroupMenuUserPreferencesFlyout",{extend:"DCT.Mvc.TaskbarGroupMenuFlyout",xtype:"dctmvcpolicylongprocesstaskbargroupmenuuserpreferencesflyout",cls:"dct-PolicyLongProcess-flyout",reference:"flyoutUserPreferences",referenceHolder:true,title:DCT.T("User Preferences"),tools:[{type:"close",itemId:"Close",qtip:DCT.T("Close"),callback:function(b,c,d){var a=b.lookupReference("formPanel");b.resetAndCloseFormPanel(a)}}],width:320,constructor:function(a){this.callParent([a]);this.buildForm(a)},buildForm:function(e){var b=this;var a=e;var c=[{xtype:"checkbox",boxLabel:DCT.T("Task"),name:"taskNotify",reference:"tasks",style:{"margin-left":"6px"},inputValue:true,checked:b.taskbarGroup.UserPreferences.Tasks},{xtype:"checkbox",boxLabel:DCT.T("Notification"),name:"systemNotify",reference:"notifications",style:{"margin-left":"6px"},inputValue:true,checked:b.taskbarGroup.UserPreferences.SystemNotifications},{xtype:"checkbox",boxLabel:DCT.T("Email"),name:"emailNotify",reference:"emails",style:{"margin-left":"6px"},inputValue:true,checked:b.taskbarGroup.UserPreferences.Emails}];var d=new Ext.FormPanel({hideLabels:true,reference:"formPanel",defaults:{anchor:"95%"},monitorValid:true,padding:5,items:c,buttons:[{text:DCT.T("Save"),formBind:true,handler:function(){var f=d;d.mask(DCT.T("Processing"));b.taskbarGroup.UserPreferences.Tasks=b.lookupReference("tasks").checked;b.taskbarGroup.UserPreferences.SystemNotifications=b.lookupReference("notifications").checked;b.taskbarGroup.UserPreferences.Emails=b.lookupReference("emails").checked;Ext.Ajax.request({url:b.taskbarGroup.controllerUrl+"UserPreferences/",method:"POST",jsonData:JSON.stringify(b.taskbarGroup.UserPreferences),headers:{"Content-Type":"application/json"},success:function(g,j){d.unmask();var h=DCT.Mvc.Util.processAjaxResponse(Ext.decode(g.responseText));if(h.wasSuccessful()){b.taskbarGroup.menu.panel.refreshItems();b.resetAndCloseFormPanel(f)}},failure:function(g,h){d.unmask()}})}},{text:DCT.T("Cancel"),handler:function(){b.resetAndCloseFormPanel(d)}}]});this.add(d)},resetAndCloseFormPanel:function(a){this.lookupReference("tasks").setValue(this.taskbarGroup.UserPreferences.Tasks);this.lookupReference("notifications").setValue(this.taskbarGroup.UserPreferences.SystemNotifications);this.lookupReference("emails").setValue(this.taskbarGroup.UserPreferences.Emails);this.taskbarGroup.menu.hideFlyout()}});Ext.define("DCT.Mvc.PolicyLongProcessTaskbarGroupMenuPanel",{extend:"DCT.Mvc.TaskbarGroupMenuPanel",id:"LRPTaskbarMenuPanel",xtype:"dctmvcpolicylongprocesstaskbargroupmenupanel",cls:"dct-PolicyLongProcess-panel",defaultType:"dctmvcpolicylongprocesstaskbargroupmenuitem",setHeaderText:function(){return Ext.String.format(DCT.T("{1}Processes for '{0}'"),this.taskbarGroup.dctReference,"\t")},setToolbarItems:function(){var b={autoWidth:true,cls:"tb-button-left",handler:function(d){var e=this.taskbarGroup;Ext.Ajax.request({url:e.controllerUrl+"deleteAllComplete",method:"POST",success:function(f,h){var g=DCT.Mvc.Util.processAjaxResponse(Ext.decode(f.responseText));if(g.wasSuccessful()){e.config.items=[];e.updateTaskBarGroup(e.config);e.menu.panel.refreshItems()}},failure:function(f,g){}})},text:DCT.T("ClearAll"),taskbarGroup:this.taskbarGroup};var c={autoWidth:true,handler:this.openUserPreferenceDialog,icon:"assets/taskbargroups/dctpolicy/img/user_edit.png",text:DCT.T("User Preferences"),taskbarGroup:this.taskbarGroup};var a=this.getDockedItems('toolbar[dock="top"]');if(!Ext.isEmpty(a)){a[0].add(b);a[0].add(c)}},setHubListeners:function(a){WorkbenchToolbar.hub.addListener("refreshlongprocesstoolbar",this.refreshItemsOuterScope)},refreshItemsOuterScope:function(){var b=WorkbenchToolbar.findByType("dctmvcpolicylongprocesstaskbargroup")[0];if(!Ext.isEmpty(b)){var a=b.menu.panel;Ext.Ajax.request({url:b.controllerUrl+"list",method:"GET",success:function(c,e){var d=DCT.Mvc.Util.processAjaxResponse(Ext.decode(c.responseText));if(d.wasSuccessful()){var f=d.payload;if(!f.hasOwnProperty("items")){f.items=[]}a.removeAllItems();b.addItems(f.items);b.scrollTo(f.items)}},failure:function(c,d){}})}},openUserPreferenceDialog:function(a,c){var b=this.taskbarGroup.menu;b.activateFlyout("flyoutUserPreferences")}});Ext.define("DCT.Mvc.PolicyLongProcessTaskbarGroupMenuItem",{extend:"DCT.Mvc.TaskbarGroupMenuItem",xtype:"dctmvcpolicylongprocesstaskbargroupmenuitem",status:null,pollingTask:null,layout:"table",statusIcon:null,statusMessage:null,statusDate:null,referenceHolder:true,tpl:"",listeners:{afterrender:{fn:function(a){a.updateMenuItem(a.config.data);a.refreshMenuItem()}}},itemTpl:new Ext.XTemplate('<div class="tskbr-g-m-i-wrapper "><div class="tskbr-g-m-i-primary clockIcon"><img width="16" src="assets/taskbargroups/dctpolicy/img/{[this.getIcon(values.notify)]}" alt="{fileName}" title="{title}"/> <span>{[this.getTitle(values.title, values.objectTypeCode, values.objectId)]}</span></div><div id="semaphoreStatus" class="tskbr-g-m-i-secondary">{statusMessage}</div><div id="semaphoreDate" class="tskbr-g-m-i-secondary">{statusDate}</div></div>',{formatDate:function(a){return a},getIcon:function(a){return"blankIcon.png"},getTitle:function(c,b,a){if(!c){c="Queue Process"}return c}}).compile(),mismatchTpl:new Ext.XTemplate('<div class="tskbr-g-m-i-wrapper "><div class="tskbr-g-m-i-secondary"> <span style="color:red">{[this.getInvalidMessage(values.objectTypeCode)]}</span></div></div>',{getInvalidMessage:function(a){var b=DCT.T(Ext.String.format("{0}QueueProcessVersionMismatch",a?a+"_":""));return b}}).compile(),imageTpl:new Ext.XTemplate('<div class="tskbr-g-m-i-wrapper "><div class="tskbr-g-m-i-primary"><img id="imageStatus" width="20" src="{statusIcon}" alt="{config.data.title}" title="{config.data.asyncID}"/></div></div>').compile(),constructor:function(a){this.callParent([a]);this.setLayoutConfig(a);this.buildContents(a);this.appendBaseClass();this.prePolling(a)},appendBaseClass:function(){if(this.config.data.valid){this.callParent()}else{if(Ext.isEmpty(this.cls)){this.cls="tskbr-g-m-item-invalid"}else{this.cls="tskbr-g-m-item-invalid "+this.cls}}},prePolling:function(a){var b=this;this.pollingTask={run:this.checkSemaphoreStatus,interval:5*1000,args:null,scope:this};this.startPolling(a.data.queueStatus)},startPolling:function(a){if(a=="1"||a=="2"||a=="3"){Ext.TaskManager.start(this.pollingTask)}},stopPolling:function(){Ext.TaskManager.stop(this.pollingTask)},updateItemStatus:function(a){switch(a){case"1":this.statusIcon="assets/taskbargroups/dctpolicy/img/blue-loading.gif";break;case"2":this.statusIcon="assets/taskbargroups/dctpolicy/img/clock_pause.png";break;case"3":this.statusIcon="assets/taskbargroups/dctpolicy/img/blue-loading.gif";break;case"4":this.statusIcon="assets/taskbargroups/dctpolicy/img/accept.png";break;case"5":this.statusIcon="assets/taskbargroups/dctpolicy/img/error.png";break}},updateItemIsValid:function(a){if(!a){this.statusIcon="assets/taskbargroups/dctpolicy/img/error.png"}},refreshMenuItem:function(){if(Ext.get("imageStatus")){this.el.query("#imageStatus")[0].src=this.statusIcon}if(Ext.get("semaphoreStatus")){this.el.query("#semaphoreStatus")[0].innerHTML=this.statusMessage}if(Ext.get("semaphoreDate")){this.el.query("#semaphoreDate")[0].innerHTML=this.statusDate}},updateMenuItem:function(a){this.status=a.queueStatus;this.statusMessage=a.notify;this.statusDate=a.start;this.updateItemStatus(this.status);if(this.status=="5"){this.statusMessage=DCT.T("Cancelled")}this.updateItemIsValid(a.valid);this.refreshMenuItem()},checkSemaphoreStatus:function(){var b=this;if(!b.config){b.stopPolling();return}var a=b.config.data.queueStatus;if(a=="1"||a=="2"||a=="3"){Ext.Ajax.request({url:this.taskbarGroup.controllerUrl+"get",method:"POST",params:{id:this.initialConfig.data.asyncID},success:function(c,e){var d=DCT.Mvc.Util.processAjaxResponse(Ext.decode(c.responseText));if(d.wasSuccessful()){if(d.payload.items[0].queueStatus!="1"&&d.payload.items[0].queueStatus!="2"&&d.payload.items[0].queueStatus!="3"){b.stopPolling()}b.updateMenuItem(d.payload.items[0])}},failure:function(c,d){}})}else{b.stopPolling();b.updateMenuItem(b.config)}},setLayoutConfig:function(a){var b=2;this.layout={type:"table",tableAttrs:{style:{width:"100%"}},columns:b}},buildContents:function(b){var a=this;this.add({xtype:"box",data:b.data,tpl:this.itemTpl,reference:"details",referenceHolder:true,style:{width:"100%"}});this.add({xtype:"box",data:this,style:{"float":"right",marginRight:"20px"},tpl:this.imageTpl,reference:"icon"});if(!b.data.valid){this.add({xtype:"box",data:b.data,tpl:this.mismatchTpl,reference:"versionMismatch",referenceHolder:true,style:{width:"100%"}})}else{this.add({xtype:"box",data:b.data,style:{width:"100%"}})}if(!b.data.valid||b.data.queueStatus=="4"||b.data.queueStatus=="5"){this.add({xtype:"button",text:"Clear",data:b.data,style:{"float":"right",marginRight:"10px"},taskbar:this.taskbarGroup,handler:function(c){a.config.data.valid=false;var d=this.config.taskbar;Ext.Ajax.request({url:this.config.taskbar.controllerUrl+"delete",method:"POST",params:{id:this.config.data.asyncID},success:function(e,g){var f=DCT.Mvc.Util.processAjaxResponse(Ext.decode(e.responseText));if(f.wasSuccessful()){d.config.items.splice(a,1);d.updateTaskBarGroup(d.config);d.menu.panel.refreshItems()}},failure:function(e,f){}})}})}},handleOnClick:function(b){if(this.config.data.valid){DCT.Util.getSafeElement("_objectId").value=this.config.data.objectId;DCT.Util.getSafeElement("_objectTypeCode").value=this.config.data.objectTypeCode;DCT.Util.getSafeElement("_asyncID").value=this.config.data.asyncID;DCT.currentPage="interview";DCT.Util.getSafeElement("_action").value="";var a=DCT.currentPage=="interview";DCT.Util.getSafeElement("_submitAction").value="";DCT.Util.getSafeElement("_targetPage").value="";DCT.Util.getSafeElement("_resumeAsync").value="1";DCT.ajaxProcess.completeContentAjax();DCT.Util.getSafeElement("_submitAction").value="";DCT.Util.getSafeElement("_targetPage").value="";DCT.Util.getSafeElement("_resumeAsync").value=""}}});