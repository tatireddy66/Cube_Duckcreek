/*
 * Duck Creek TaskBar JavaScript
 */
Ext.define("DCT.Mvc.PolicyAttachmentsTaskbarGroup",{extend:"DCT.Mvc.TaskbarGroup",xtype:"dctmvcpolicyattachmentstaskbargroup",text:DCT.T("Attachments"),icon:"assets/taskbargroups/dctpolicy/img/attach.png",menu:{xtype:"dctmvcpolicyattachmentstaskbargroupmenu"},controllerUrl:"attachments/",emptyItemsData:{message:DCT.T("NoAttachmentsMessage")},deleteAttachment:function(a){a.taskbarGroup.confirmAction(DCT.T("AreYouSure"),DCT.T("AreYouSureDeleteAttachment"),a.taskbarGroup.doDeleteAttachment,a)},doDeleteAttachment:function(b){var d=this;if(b=="yes"){var c=d.child("box");var a=d.taskbarGroup.controllerUrl+"delete/"+c.data.attachmentID;Ext.Ajax.request({url:a,method:"GET",success:function(f,h){var g=DCT.Mvc.Util.processAjaxResponse(Ext.decode(f.responseText));if(g.wasSuccessful()){var e=d.taskbarGroup.menu.panel;e.remove(d.id,true);if(e.items.getCount()<1){e.setEmptyItemsPanel()}}},failure:function(e,f){}})}},openAddAttachmentPanel:function(b,d){var c=this;var a=c.findParentByType("dctmvcpolicyattachmentstaskbargroup");a.menu.activateFlyout("flyoutAddAttachment")}});Ext.define("DCT.Mvc.PolicyAttachmentsTaskbarGroupMenu",{extend:"DCT.Mvc.TaskbarGroupMenu",xtype:"dctmvcpolicyattachmentstaskbargroupmenu",setFlyoutConfigs:function(){return[{xtype:"dctmvcpolicyattachmentstaskbargroupmenuflyout"}]},setMenuPanelXtype:function(){return"dctmvcpolicyattachmentstaskbargroupmenupanel"}});Ext.define("DCT.Mvc.PolicyAttachmentsTaskbarGroupMenuPanel",{extend:"DCT.Mvc.TaskbarGroupMenuPanel",xtype:"dctmvcpolicyattachmentstaskbargroupmenupanel",defaultType:"dctmvcpolicyattachmentstaskbargroupmenuitem",setHeaderText:function(){var a=this;return DCT.T("AttachmentsFor_colon")+" "+a.taskbarGroup.dctReference},setToolbarItems:function(){var b=this;if(b.taskbarGroup.userHasPrivilege("CanAddAttachments")){var c={autoWidth:false,handler:b.taskbarGroup.openAddAttachmentPanel,icon:"assets/taskbargroups/dctpolicy/img/add.png",text:DCT.T("AddAnAttachment")};var a=b.getDockedItems('toolbar[dock="top"]');if(!Ext.isEmpty(a)){a[0].add(c)}}}});Ext.define("DCT.Mvc.PolicyAttachmentsTaskbarGroupMenuItem",{extend:"DCT.Mvc.TaskbarGroupMenuItem",xtype:"dctmvcpolicyattachmentstaskbargroupmenuitem",cls:"dctmvcpolicyattachmentstaskbargroupmenuitem",referenceHolder:true,tpl:"",itemTpl:new Ext.XTemplate('<div class="tskbr-g-m-i-wrapper "><div class="tskbr-g-m-i-primary"><img width="16" src="assets/taskbargroups/dctpolicy/img/{[this.getIcon(values.fileName)]}" alt="{fileName}" title="{subject}"/> <span>{subject}</span></div><div class="tskbr-g-m-i-secondary">{fileName}</div><div class="tskbr-g-m-i-secondary">{[this.formatDate(values.attachmentDate)]}</div></div>',{formatDate:function(d){var c=Ext.getDom("_hiddenExtJsDateformat").value;var b=Ext.Date.parse(d,"c");var a=Ext.Date.format(b,c+", g:i a");return a},getIcon:function(a){var b=DCT.Util.getFileExtension(a);var c=Ext.getStore("iconStore");return c.getIcon(b)}}).compile(),constructor:function(a){var b=this;b.createStore(a);b.callParent([a]);b.setLayoutConfig(a);b.buildContents(a)},createStore:function(a){var b=this;Ext.create("DCT.Mvc.IconManager",{})},setLayoutConfig:function(a){var b=this;var c=(b.taskbarGroup.userHasPrivilege("CanDeleteAttachments"))?2:1;b.layout={type:"table",tableAttrs:{style:{width:"100%"}},columns:c}},buildContents:function(a){var b=this;b.add({xtype:"box",scrollable:true,data:a.data,tpl:b.itemTpl,reference:"details",style:{width:"100%"},listeners:{render:{fn:function(){var d=this;var c=d.lookupReference("details");c.el.on("click",function(h,f){var g=this;g.setActiveMenuItem(g);g.handleOnClick()},d,{delegate:".tskbr-g-m-i-primary"})},scope:b}}});if(b.taskbarGroup.userHasPrivilege("CanDeleteAttachments")){b.add({xtype:"button",cls:"deleteAttachments",icon:"assets/taskbargroups/dctpolicy/img/decline.png",text:DCT.T("Delete"),handler:function(){b.taskbarGroup.deleteAttachment(b)}})}},configureHandler:function(){},handleOnClick:function(){var b=this;var a=document.forms[0].action;document.forms[0].action=b.taskbarGroup.controllerUrl+"get";DCT.Util.getSafeElement("id").value=b.initialConfig.data.attachmentID;document.forms[0].submit();document.forms[0].action=a},callDeleteAttachment:function(a,g){var d=this;var c=d.findParentByType("dctmvcpolicyattachmentstaskbargroup");var f=d.findParentByType("dctmvcpolicyattachmentstaskbargroupmenuitem");c.activeMenuItem=f;c.deleteAttachment(a,g)}});Ext.define("DCT.Mvc.PolicyAttachmentsTaskbarGroupMenuFlyout",{extend:"DCT.Mvc.TaskbarGroupMenuFlyout",xtype:"dctmvcpolicyattachmentstaskbargroupmenuflyout",reference:"flyoutAddAttachment",unstyled:false,constructor:function(a){var b=this;b.callParent([a]);b.buildForm(a)},buildForm:function(b){var c=this;var a=Ext.create("Ext.FormPanel",{title:DCT.T("AddAnAttachment"),tools:[{type:"close",itemId:"Close",qtip:DCT.T("Close"),callback:function(d,e,f){c.resetAndCloseFormPanel(a)}}],fieldDefaults:{labelAlign:"top",labelWidth:75},defaults:{anchor:"95%"},monitorValid:true,padding:5,defaultType:"textfield",fileUpload:true,url:c.taskbarGroup.controllerUrl+"add",items:[{fieldLabel:DCT.T("Caption"),name:"caption",allowBlank:false},{xtype:"filefield",allowBlank:false,emptyText:DCT.T("SelectAFile"),fieldLabel:DCT.T("Attachment"),name:"file",buttonText:DCT.T("Browse")}],buttons:[{text:DCT.T("AddAttachment"),formBind:true,handler:function(){var d=a;a.mask(DCT.T("Processing"));a.getForm().submit({success:function(f,g){a.unmask();var e=DCT.Mvc.Util.processAjaxResponse(Ext.decode(g.response.responseText));c.taskbarGroup.menu.panel.refreshItems();c.resetAndCloseFormPanel(d)},failure:function(f,g){a.unmask();var e=DCT.Mvc.Util.processAjaxResponse(Ext.decode(g.response.responseText));if(!e.sessionHasExpired()){c.taskbarGroup.displayWarningMessage(DCT.T("Alert"),e.message,function(){c.taskbarGroup.menu.showFlyout();c.taskbarGroup.showMenu()},c)}}})}},{text:DCT.T("Cancel"),handler:function(){c.resetAndCloseFormPanel(a)}}]});c.add(a)},resetAndCloseFormPanel:function(a){var b=this;a.getForm().reset();b.taskbarGroup.menu.hideFlyout()}});