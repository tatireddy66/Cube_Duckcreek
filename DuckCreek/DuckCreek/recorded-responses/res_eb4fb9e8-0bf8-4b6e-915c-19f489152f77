/*
 * Duck Creek TaskBar JavaScript
 */
Ext.define("DCT.Mvc.PolicyTasksTaskbarGroup",{extend:"DCT.Mvc.TaskbarGroup",xtype:"dctmvcpolicytaskstaskbargroup",text:DCT.T("Tasks_noColon"),icon:"assets/taskbargroups/dctpolicy/img/clipboard.png",menu:{xtype:"dctmvcpolicytaskstaskbargroupmenu"},controllerUrl:"tasks/",emptyItemsData:{message:DCT.T("NoTasksMessage")},id:"taskstaskbargroup",scrollTo:function(b){var a=this;var c=a.menu;if(c&&isNaN(c.scrollToTaskId)==false){c.scrollToNewItem(b)}},completeTask:function(b,e){var c=this;var d=c.findParentByType("dctmvcpolicytaskstaskbargroupmenudetailsflyout");var a=d.taskbarGroup;a.confirmAction(DCT.T("AreYouSure"),DCT.T("AreYouSureTaskComplete"),a.doCompleteTask,a)},doCompleteTask:function(a){var b=this;if(a=="yes"){var d=b.activeMenuItem;var c=b.activeMenuItem.initialConfig.data;Ext.Ajax.request({url:b.controllerUrl+"complete",method:"POST",params:{taskId:c.Id,taskLockingTS:c.LockingTs},success:function(e,g){var f=DCT.Mvc.Util.processAjaxResponse(Ext.decode(e.responseText));if(f.wasSuccessful()){b.menu.hideFlyout();b.menu.panel.remove(d.id,true);if(b.menu.panel.items.getCount()<1){b.menu.panel.setEmptyItemsPanel()}WorkbenchToolbar.hub.fireEvent("taskcompleted",b.activeMenuItem.initialConfig.data.Id);b.menu.panel.refreshItems();b.showMenu()}},failure:function(e,f){}})}else{b.menu.showFlyout();b.showMenu()}},pickupTask:function(){var b=this;var e=b.findParentByType("dctmvcpolicytaskstaskbargroupmenudetailsflyout");var a=e.taskbarGroup;var d=a.activeMenuItem;var c=a.activeMenuItem.initialConfig.data;Ext.Ajax.request({url:a.controllerUrl+"pickup",method:"POST",params:{taskId:c.Id,taskLockingTS:c.LockingTs},success:function(f,h){var g=DCT.Mvc.Util.processAjaxResponse(Ext.decode(f.responseText));if(g.wasSuccessful()){a.getTask(e);WorkbenchToolbar.hub.fireEvent("taskpickedup",a.activeMenuItem.initialConfig.data.Id);a.menu.panel.refreshItems()}},failure:function(f,g){}})},getTask:function(d){var a=this;var c=a.activeMenuItem;var b=a.activeMenuItem.initialConfig.data;Ext.Ajax.request({url:a.controllerUrl+"get",method:"POST",params:{taskId:b.Id},success:function(e,g){var f=DCT.Mvc.Util.processAjaxResponse(Ext.decode(e.responseText));if(f.wasSuccessful()){d.pickUpdate(f.payload[0])}},failure:function(e,f){}})}});Ext.define("DCT.Mvc.PolicyTasksTaskbarGroupMenu",{extend:"DCT.Mvc.TaskbarGroupMenu",xtype:"dctmvcpolicytaskstaskbargroupmenu",id:"TasksForPanelId",scrollToTaskId:0,defaultFlyout:"flyoutTaskDetails",style:{overflow:"visible"},setFlyoutConfigs:function(){return[{xtype:"dctmvcpolicytaskstaskbargroupmenudetailsflyout"},{xtype:"dctmvcpolicytaskstaskbargroupmenuaddtaskflyout"}]},setMenuPanelXtype:function(){return"dctmvcpolicytaskstaskbargroupmenupanel"},scrollToNewItem:function(e){var k=this;var a=k.el.select("div.dct-policytasks-panel");var f=a.down("div.x-panel-body");var b=f.id;var d=k.el.query("div.tskbr-g-m-item");var j=0;var h=0;var g=0;if(!Ext.isEmpty(d)){for(g=0;g<e.length;g++){var m=Ext.get(d[g].id);j=j+m.getHeight();if(e[g].Id==k.scrollToTaskId){h=j}}}var i=(a._fly)?a._fly.getHeight():0;var l=h-parseInt(i/2);if(b!=null&&b!=undefined){var c=Ext.get(b);c.scrollTo("top",l)}}});Ext.define("DCT.Mvc.PolicyTasksTaskbarGroupMenuDetailsFlyout",{extend:"DCT.Mvc.TaskbarGroupMenuFlyout",xtype:"dctmvcpolicytaskstaskbargroupmenudetailsflyout",bbar:[{xtype:"tbfill"}],cls:"dct-policytasks-flyout",layout:"border",reference:"flyoutTaskDetails",referenceHolder:true,title:DCT.T("TaskDetails"),tools:[{type:"close",itemId:"Close",qtip:DCT.T("Close"),callback:function(a,b,c){a.taskbarGroup.menu.hideFlyout()}}],width:300,height:400,tplTaskDetail:new Ext.XTemplate('<div class="tskbr-g-m-i-wrapper"><div class="tskbr-g-m-i-wrapper"><table border="0" style="width:100%" class="tskbr-g-m-i-primarydetails"><tr id={[this.setLink(values.Id)]}><td style="vertical-align:text-top;">{[DCT.T("Title_colon")]}</td><td class="tskbr-g-m-i-primarydetailslink"><div class="tskbr-g-m-i-primarydetailswrap">{[fm.nl2br(Ext.util.Format.htmlEncode(values.Title))]}</div></td><td><tpl if="AssignedToCurrentUser == &quot;true&quot;"><img align="right" src="assets/taskbargroups/dctpolicy/img/clipboard_pencil.png" alt="{[DCT.T("AssignedTo_colon")]} {AssignedFullName}" title="{[DCT.T("AssignedTo_colon")]} {AssignedFullName}"></tpl></td></tr><tr><td>{[DCT.T("PolicyQuoteNumSymbol_colon")]}</td><td>{Reference}</td><td></td></tr><tr><td>{[DCT.T("Category_colon")]}</td><td>{Type}</td><td></td></tr><tr><td>{[DCT.T("DueDate_colon")]}</td><td><span>{[this.formatSQLDate(values.DueDate)]} </span><tpl if="DueDateStatus == &quot;overdue&quot;"><img class="tskbr-g-m-i-primarydetailsimage" width="16" src="assets/taskbargroups/dctpolicy/img/icoDateAlert.png" alt="{[DCT.T("Overdue")]}" title="{[DCT.T("Overdue")]}"/></tpl><tpl if="DueDateStatus == &quot;dueToday&quot;"><img class="tskbr-g-m-i-primarydetailsimage" width="16" src="assets/taskbargroups/dctpolicy/img/icoDateWarn.png" alt="{[DCT.T("DueToday")]}" title="{[DCT.T("DueToday")]}"/></tpl></td><td></td></tr><tr><td>{[DCT.T("State_colon_status")]}</td><td>{Status}</td><td></td></tr><tr><td>{[DCT.T("Created_colon")]}</td><td>{[this.formatDate(values.CreationDate)]}</td><td></td></tr><tr><td>{[DCT.T("CreatedBy_colon")]}</td><td>{CreatedByFullName}</td><td></td></tr><tr><td>{[DCT.T("Queue_colon")]}</td><td>{QueueName}</td><td></td></tr><tr><td>{[DCT.T("Assignee_colon")]}</td><td>{AssignedFullName}</td><td></td></tr><tr><td style="vertical-align:text-top;">{[DCT.T("Description_colon")]}</td><td><div class="tskbr-g-m-i-primarydetailswrap">{[fm.nl2br(Ext.util.Format.htmlEncode(values.Description))]}</div></td><td></td></tr></table><div class="x-clear"></div></div></div>',{setLink:function(b){var c=this;var a=Ext.id()+b;Ext.Function.defer(c.addListener,1,c,[a,b]);return a},addListener:function(b,a){Ext.get(b).on("click",function(c){c.stopEvent();DCT.Submit.viewTask(a,"taskManagement")})},formatDate:function(d){var b="";if(d.length>0){var c=Ext.getDom("_hiddenExtJsDateformat").value;var a=Ext.Date.parse(d,"c");var b=Ext.Date.format(a,c+" g:i a")}return b},formatSQLDate:function(d){var b="";if(d.length>0){var c=Ext.getDom("_hiddenExtJsDateformat").value;var a=Ext.Date.parse(d,"n/j/Y");var b=Ext.Date.format(a,c)}return b}}).compile(),constructor:function(a){var b=this;b.callParent([a]);b.buildPanel(a);b.addTaskActions()},formatSQLDate:function(d){var c=Ext.getDom("_hiddenExtJsDateformat").value;var b=Ext.Date.parse(d,"n/j/Y");var a=Ext.Date.format(b,c);return a},update:function(){var b=this;data=b.taskbarGroup.activeMenuItem.initialConfig.data,btnComplete=b.lookupReference("btnCompleteTask"),btnPickup=b.lookupReference("btnPickupTask"),regionCenter=b.lookupReference("regionCenter");if(btnComplete){btnComplete.hide()}if(btnPickup){btnPickup.hide()}regionCenter.update(data);if(data.AssignedFullName==""&&(btnPickup)){btnPickup.show()}else{if(data.AssignedToCurrentUser=="true"&&(btnComplete)){btnComplete.show()}}var a=Ext.getCmp("TasksForPanelId");if(a){a.scrollToTaskId=data.Id}},pickUpdate:function(b){var a=this;data=a.taskbarGroup.activeMenuItem.initialConfig.data,btnComplete=a.lookupReference("btnCompleteTask"),btnPickup=a.lookupReference("btnPickupTask"),regionCenter=a.lookupReference("regionCenter");if(btnComplete){btnComplete.hide()}if(btnPickup){btnPickup.hide()}data.LockingTs=b.LockingTs;data.Title=b.Title;data.DueDate=b.DueDate;data.AssignedFullName=b.AssignedFullName;regionCenter.update(b);if(data.AssignedFullName==""&&(btnPickup)){btnPickup.show()}else{if(b.AssignedToCurrentUser=="true"&&(btnComplete)){btnComplete.show()}}},addTaskActions:function(){var c=this;var a=c.setTaskPickupConfig();var b=c.getDockedItems('toolbar[dock="bottom"]');if(a!=false){if(!Ext.isEmpty(b)){b[0].add(a)}}var d=c.setTaskCompleteConfig();if(d!=false){if(!Ext.isEmpty(b)){b[0].add(d)}}},buildPanel:function(a){var b=this;b.add({scrollable:true,region:"center",reference:"regionCenter",tpl:b.tplTaskDetail})},setTaskPickupConfig:function(){var a=this;if(a.taskbarGroup.userHasPrivilege("canEditTasks")){return{xtype:"button",reference:"btnPickupTask",id:"btnPickupTask",handler:a.taskbarGroup.pickupTask,icon:"assets/taskbargroups/dctpolicy/img/clipboard_link.png",text:DCT.T("PickUp")}}else{return false}},setTaskCompleteConfig:function(){var a=this;if(a.taskbarGroup.userHasPrivilege("canEditTasks")){return{xtype:"button",reference:"btnCompleteTask",id:"btnCompleteTask",handler:a.taskbarGroup.completeTask,icon:"assets/taskbargroups/dctpolicy/img/clipboard_tick.png",text:DCT.T("Complete")}}else{return false}}});Ext.define("DCT.Mvc.PolicyTasksTaskbarGroupMenuAddTaskFlyout",{extend:"DCT.Mvc.TaskbarGroupMenuFlyout",xtype:"dctmvcpolicytaskstaskbargroupmenuaddtaskflyout",cls:"dct-policytasks-flyout",id:"addTaskFly",reference:"flyoutAddTask",referenceHolder:true,title:DCT.T("AddATask"),tools:[{type:"close",itemId:"Close",qtip:DCT.T("Close"),callback:function(a,b,c){a.taskbarGroup.menu.hideFlyout()}}],width:320,style:{overflow:"visible"},bodyCls:"taskbr-dropdown",constructor:function(a){var b=this;b.callParent([a]);b.buildForm(a);b.setAddTaskPanel()},setAddTaskPanel:function(){var b=this,a=b.lookupReference("addTaskPanel");if(a){b.addTaskPanel=a}},restorePanels:function(a){a.taskbarGroup.menu.showFlyout();a.taskbarGroup.showMenu();a.taskbarGroup.menu.showFlyout()},buildForm:function(e){var f=this;var a=[];Ext.each(f.taskbarGroup.TaskQueues,function(h,g){a.push([h.EntityId,h.Name])});var d=Ext.get("_hiddenExtJsDateformat").getValue();var b=Ext.Date.format(new Date(),d);var c=Ext.create("Ext.FormPanel",{flyoutPanel:f,reference:"addTaskPanel",defaults:{anchor:"95%"},id:"addTaskPanel",fieldDefaults:{labelAlign:"top",labelWidth:75},monitorValid:true,padding:5,listeners:{render:{fn:function(g){var i=g.getComponent("taskTitleId");i.on("validitychange",function(l,k,j){Ext.getCmp("saveButton").setDisabled(!k)});var h=g.getComponent("taskQueueCombo");h.on("validitychange",function(l,k,j){Ext.getCmp("saveButton").setDisabled(!k)})}}},items:[{xtype:"textfield",allowBlank:false,fieldLabel:DCT.T("Title")+":*",labelSeparator:" ",id:"taskTitleId",maxLength:50,name:"taskTitle",stripCharsRe:/(^\s+)/g},{xtype:"combo",anchor:"70%",id:"taskTypeCombo",fieldLabel:DCT.T("TaskType"),displayField:"text",valueField:"value",allowBlank:false,mode:"local",width:98,triggerAction:"all",emptyText:DCT.T("Select_parentheses"),enableKeyEvents:true,forceSelection:true,editable:true,autoDestroy:true,value:"GEN",stripCharsRe:/(^\s+)/g,store:Ext.create("Ext.data.ArrayStore",{data:[["GEN","General"],["UA","Underwriting Account"]],fields:["value","text"]}),name:"taskType",typeAhead:true,listeners:{load:function(){var g=this;g.combo.setValue(null)}}},{xtype:"datefield",fieldLabel:DCT.T("DueDate"),name:"dueDate",id:"dueDateId",value:b,enableKeyEvents:true,hideTrigger:false,format:d,altFormats:Ext.form.DateField.prototype.altFormats+"|m-d-Y|n-j-Y|n-j-y|m-j-y|n-d-y|m-j-Y|n-d-Y|m-d",invalidText:DCT.T("ValueWithIsNotValidDate"),pickerId:"dueDatePickerId",stripCharsRe:/(^\s+|\s+$)/g,menu:Ext.create("Ext.menu.DatePicker",{hideOnClick:false,allowOtherMenus:true})},{xtype:"textarea",id:"taskDescriptionId",fieldLabel:DCT.T("Description"),maxLength:200,name:"taskDescription",stripCharsRe:/(^\s+)/g},{xtype:"combo",anchor:"70%",id:"taskQueueCombo",fieldLabel:DCT.T("Queue")+":*",labelSeparator:" ",displayField:"text",valueField:"value",allowBlank:false,mode:"local",width:98,triggerAction:"all",emptyText:DCT.T("Select_parentheses"),enableKeyEvents:true,forceSelection:true,editable:true,autoDestroy:true,validateOnBlur:true,stripCharsRe:/(^\s+)/g,store:Ext.create("Ext.data.ArrayStore",{data:a,fields:["value","text"]}),name:"taskQueue",typeAhead:true,listeners:{load:function(){var g=this;g.combo.setValue(null)}}},{xtype:"checkbox",hideLabel:true,boxLabel:DCT.T("AssignToMe"),boxLabelAlign:"before",checked:function(){return c.flyoutPanel.taskbarGroup.userHasPrivilege("canAssignTasks")},name:"assignTaskToMe",id:"assignTask"}],buttons:[{text:DCT.T("Save"),formBind:true,id:"saveButton",handler:function(){var h=this;var g=c;c.mask(DCT.T("Processing"));h.setVisible(false);Ext.Ajax.request({url:g.flyoutPanel.taskbarGroup.controllerUrl+"add",method:"POST",params:g.getForm().getFieldValues(false),success:function(i,l){c.unmask();var k=DCT.Mvc.Util.processAjaxResponse(Ext.decode(i.responseText));h.setVisible(true);if(k.wasSuccessful()){var j=k.payload[0].Id;g.flyoutPanel.taskbarGroup.menu.scrollToTaskId=j;WorkbenchToolbar.hub.fireEvent("taskadded",j);g.flyoutPanel.taskbarGroup.menu.panel.refreshItems();g.flyoutPanel.resetAndCloseFormPanel(g)}},failure:function(i,j){c.unmask()}})}},{text:DCT.T("Cancel"),handler:function(){f.resetAndCloseFormPanel(c)}}]});f.add(c)},resetAndCloseFormPanel:function(a){var b=this;a.getForm().reset();b.taskbarGroup.menu.hideFlyout()}});Ext.define("DCT.Mvc.PolicyTasksTaskbarGroupMenuPanel",{extend:"DCT.Mvc.TaskbarGroupMenuPanel",xtype:"dctmvcpolicytaskstaskbargroupmenupanel",cls:"dct-policytasks-panel",defaultType:"dctmvcpolicytaskstaskbargroupmenuitem",setHeaderText:function(){var a=this;return DCT.T("TasksFor_colon")+" "+a.taskbarGroup.dctReference},setToolbarItems:function(){var b=this;if(b.taskbarGroup.userHasPrivilege("canAddTask")||b.taskbarGroup.userHasPrivilege("canAssignTasks")){var c={autoWidth:false,handler:b.openAddTaskDialog,icon:"assets/taskbargroups/dctpolicy/img/add.png",text:DCT.T("AddATask"),taskbarGroup:b.taskbarGroup};var a=b.getDockedItems('toolbar[dock="top"]');if(!Ext.isEmpty(a)){a[0].add(c)}}},openAddTaskDialog:function(b,e){var c=this;var d=c.taskbarGroup.menu;d.activateFlyout("flyoutAddTask");d.flyout.addTaskPanel.form.clearInvalid();if(!c.taskbarGroup.userHasPrivilege("canAssignTasks")){var a=Ext.getCmp("assignTask");a.setValue("");a.hide()}else{if(!c.taskbarGroup.userHasPrivilege("canAddTask")){var a=Ext.getCmp("assignTask");a.hide()}}}});DCT.Mvc.WorkBookTask={wbTaskDescriptionIndex:0,wbTaskIndex:0};Ext.define("DCT.Mvc.PolicyTasksTaskbarGroupMenuItem",{extend:"DCT.Mvc.TaskbarGroupMenuItem",xtype:"dctmvcpolicytaskstaskbargroupmenuitem",tpl:new Ext.XTemplate('<div class="tskbr-g-m-i-wrapper" id="{[this.nextTaskId()]}"><div class="tskbr-g-m-i-primary" title="{[DCT.T("Title_colon")]} {[fm.htmlEncode(values.Title)]}"><tpl if="AssignedFullName != &quot;&quot;"><img align="right" src="assets/taskbargroups/dctpolicy/img/clipboard_pencil.png" alt="{[DCT.T("AssignedTo_colon")]} {AssignedFullName}" title="{[DCT.T("AssignedTo_colon")]} {AssignedFullName}"></tpl><tpl if="DueDateStatus == &quot;overdue&quot;"><img align="right" src="assets/taskbargroups/dctpolicy/img/icoDateAlert.png" alt="{[DCT.T("Overdue")]}" title="{[DCT.T("Overdue")]}"/></tpl><tpl if="DueDateStatus == &quot;dueToday&quot;"><img align="right" src="assets/taskbargroups/dctpolicy/img/icoDateWarn.png" alt="{[DCT.T("DueToday")]}" title="{[DCT.T("DueToday")]}"/></tpl>{[fm.htmlEncode([fm.ellipsis(values.Title, 25)])]}</div><div class="tskbr-g-m-i-secondary" id="{[this.nextDescriptionId()]}" title="{[DCT.T("Description_colon")]} {[fm.htmlEncode(values.Description)]}">{[fm.htmlEncode([fm.ellipsis(values.Description, 30)])]}</div><div class="tskbr-g-m-i-secondary">{[this.formatDate(values.DueDate)]}</div><div class="x-clear"></div></div>',{formatDate:function(d){var b="";if(d.length>0){var c=Ext.getDom("_hiddenExtJsDateformat").value;var a=Ext.Date.parse(d,"n/j/Y");b=Ext.Date.format(a,c)}return b},nextDescriptionId:function(){DCT.Mvc.WorkBookTask.wbTaskDescriptionIndex++;var a="wbtaskdescriptionid"+DCT.Mvc.WorkBookTask.wbTaskDescriptionIndex.toString();return a},nextTaskId:function(){DCT.Mvc.WorkBookTask.wbTaskIndex++;var a="wbtaskid"+DCT.Mvc.WorkBookTask.wbTaskIndex.toString();return a}}).compile(),handleOnClick:function(){var a=this;var b=a.taskbarGroup.menu;b.activateFlyout("flyoutTaskDetails");b.flyout.update()}});